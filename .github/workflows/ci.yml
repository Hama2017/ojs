name: Continuous Integration

on:
  push:
    branches: [ feat/premium-helper-plugin-hamadouba ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Plugin Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, json, tokenizer
        tools: composer
        
    - name: Install PHP_CodeSniffer
      run: |
        composer global require "squizlabs/php_codesniffer=*"
        echo "$HOME/.composer/vendor/bin" >> $GITHUB_PATH
        
    - name: Verify CodeSniffer installation
      run: |
        phpcs --version
        phpcs -i
        
    # SEULEMENT votre plugin - pas tout OJS
    - name: Run PHP_CodeSniffer on Premium Submission Helper Plugin
      run: |
        echo "ğŸ” Running PSR-12 linting on Premium Submission Helper Plugin only..."
        
        # DÃ©finir le chemin de votre plugin
        PLUGIN_PATH="plugins/generic/premiumSubmissionHelper"
        
        if [ -d "$PLUGIN_PATH" ]; then
          echo "ğŸ“‚ Plugin found at: $PLUGIN_PATH"
          echo "ğŸ“ Files to be analyzed:"
          find $PLUGIN_PATH -name "*.php" -type f
          echo ""
          
          # Lancer PSR-12 SEULEMENT sur votre plugin
          phpcs --standard=PSR12 --extensions=php $PLUGIN_PATH/ --ignore=*/vendor/*,*/node_modules/*
          
          echo "âœ… PSR-12 analysis completed for Premium Submission Helper Plugin"
        else
          echo "âŒ Plugin directory not found at: $PLUGIN_PATH"
          echo "ğŸ“‚ Available plugin directories:"
          find plugins/generic/ -maxdepth 1 -type d 2>/dev/null || echo "No generic plugins found"
          exit 1
        fi
        
    - name: PHP Syntax Check (Plugin only)
      run: |
        echo "ğŸ” Checking PHP syntax for Premium Submission Helper Plugin..."
        PLUGIN_PATH="plugins/generic/premiumSubmissionHelper"
        
        if [ -d "$PLUGIN_PATH" ]; then
          find $PLUGIN_PATH -name "*.php" -type f -exec php -l {} \;
          echo "âœ… PHP syntax check completed"
        else
          echo "âš ï¸ Plugin directory not found for syntax check"
          exit 1
        fi
        
    - name: Security Check (Plugin only)
      run: |
        echo "ğŸ” Basic security scan for Premium Submission Helper Plugin..."
        PLUGIN_PATH="plugins/generic/premiumSubmissionHelper"
        
        if [ -d "$PLUGIN_PATH" ]; then
          # VÃ©rifier les hardcoded API keys dans votre plugin
          if grep -r "api_key\s*=\s*['\"][a-zA-Z0-9]\{10,\}['\"]" --include="*.php" $PLUGIN_PATH 2>/dev/null; then
            echo "âš ï¸ Warning: Potential hardcoded API keys found"
            exit 1
          fi
          
          # VÃ©rifier les hardcoded passwords dans votre plugin
          if grep -r "password\s*=\s*['\"][a-zA-Z0-9]\{5,\}['\"]" --include="*.php" $PLUGIN_PATH 2>/dev/null; then
            echo "âš ï¸ Warning: Potential hardcoded passwords found"
            exit 1
          fi
          
          echo "âœ… Security scan completed - no hardcoded credentials found"
        else
          echo "âš ï¸ Plugin directory not found for security scan"
          exit 1
        fi
        
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: lint
    if: always()
    
    steps:
    - name: Results Summary
      run: |
        echo "ğŸ‰ Premium Submission Helper Plugin - CI Analysis Complete!"
        echo ""
        echo "âœ… Tests performed:"
        echo "  â€¢ PSR-12 code style compliance"
        echo "  â€¢ PHP syntax validation"
        echo "  â€¢ Basic security scan"
        echo ""
        echo "ğŸ“Š Scope: Premium Submission Helper Plugin ONLY"
        echo "ğŸ¯ Focus: Your plugin code quality, not entire OJS system"
