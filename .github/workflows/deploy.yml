name: Deploy to Production

# D√©clenchement manuel uniquement
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  deploy:
    name: Deploy Plugin to OJS Server
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    # √âtape 1: R√©cup√©rer le code
    - name: Checkout code
      uses: actions/checkout@v4
      
    # √âtape 2: Pr√©parer les fichiers pour d√©ploiement
    - name: Prepare deployment files
      run: |
        echo "üì¶ Preparing plugin files for deployment..."
        
        # Cr√©er un dossier temporaire
        mkdir -p deployment/premiumSubmissionHelper
        
        # Copier tous les fichiers n√©cessaires (exclure les fichiers de dev)
        rsync -av --progress . deployment/premiumSubmissionHelper/ \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          --exclude='*.md' \
          --exclude='.gitignore'
        
        # Afficher la structure des fichiers
        echo "üìÇ Plugin structure:"
        find deployment/premiumSubmissionHelper -type f | head -20
        
    # √âtape 3: Cr√©er une archive
    - name: Create deployment archive
      run: |
        cd deployment
        tar -czf premiumSubmissionHelper.tar.gz premiumSubmissionHelper/
        echo "‚úÖ Archive created: $(ls -lh premiumSubmissionHelper.tar.gz)"
        
    # √âtape 4: Configurer SSH
    - name: Setup SSH
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USER }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
        echo "SSH configuration completed"
        
    # √âtape 5: Tester la connexion SSH
    - name: Test SSH Connection
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USER }}
      run: |
        echo "üîå Testing SSH connection..."
        ssh -o ConnectTimeout=10 $SSH_USER@$SSH_HOST "echo '‚úÖ SSH connection successful'"
        
    # √âtape 6: Backup existant (si pr√©sent)
    - name: Backup existing plugin
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USER }}
        OJS_PATH: ${{ secrets.OJS_PATH }}
      run: |
        echo "üíæ Creating backup of existing plugin..."
        ssh $SSH_USER@$SSH_HOST "
          if [ -d '$OJS_PATH/plugins/generic/premiumSubmissionHelper' ]; then
            sudo cp -r '$OJS_PATH/plugins/generic/premiumSubmissionHelper' '$OJS_PATH/plugins/generic/premiumSubmissionHelper.backup.$(date +%Y%m%d_%H%M%S)'
            echo '‚úÖ Backup created successfully'
          else
            echo '‚ÑπÔ∏è  No existing plugin found, skipping backup'
          fi
        "
        
    # √âtape 7: D√©ployer le plugin
    - name: Deploy Plugin
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USER }}
        OJS_PATH: ${{ secrets.OJS_PATH }}
      run: |
        echo "üöÄ Deploying plugin to server..."
        
        # Transf√©rer l'archive
        scp deployment/premiumSubmissionHelper.tar.gz $SSH_USER@$SSH_HOST:/tmp/
        
        # D√©ployer sur le serveur
        ssh $SSH_USER@$SSH_HOST "
          cd /tmp
          
          # Supprimer l'ancien plugin
          sudo rm -rf '$OJS_PATH/plugins/generic/premiumSubmissionHelper'
          
          # Extraire le nouveau plugin
          tar -xzf premiumSubmissionHelper.tar.gz
          
          # D√©placer vers le bon dossier
          sudo mv premiumSubmissionHelper '$OJS_PATH/plugins/generic/'
          
          # D√©finir les bonnes permissions
          sudo chown -R www-data:www-data '$OJS_PATH/plugins/generic/premiumSubmissionHelper'
          sudo chmod -R 755 '$OJS_PATH/plugins/generic/premiumSubmissionHelper'
          
          # Nettoyer les fichiers temporaires
          rm -f premiumSubmissionHelper.tar.gz
          
          echo '‚úÖ Plugin deployed successfully'
        "
        
    # √âtape 8: V√©rifier le d√©ploiement
    - name: Verify Deployment
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USER }}
        OJS_PATH: ${{ secrets.OJS_PATH }}
      run: |
        echo "üîç Verifying deployment..."
        ssh $SSH_USER@$SSH_HOST "
          if [ -f '$OJS_PATH/plugins/generic/premiumSubmissionHelper/PremiumSubmissionHelperPlugin.php' ]; then
            echo '‚úÖ Plugin main file exists'
            echo 'üìÇ Plugin structure:'
            ls -la '$OJS_PATH/plugins/generic/premiumSubmissionHelper/'
          else
            echo '‚ùå Plugin deployment failed'
            exit 1
          fi
        "
        
    # √âtape 9: Notification de succ√®s
    - name: Deployment Success
      run: |
        echo "üéâ Deployment completed successfully!"
        echo "üìä Deployment Summary:"
        echo "  ‚Ä¢ Environment: ${{ github.event.inputs.environment }}"
        echo "  ‚Ä¢ Branch: ${{ github.ref }}"
        echo "  ‚Ä¢ Commit: ${{ github.sha }}"
        echo "  ‚Ä¢ Deployed by: ${{ github.actor }}"
        echo "  ‚Ä¢ Time: $(date)"
